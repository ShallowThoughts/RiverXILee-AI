<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RiverXILee-AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css" id="hljs-light">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" id="hljs-dark">
    <link rel="stylesheet" href="./css/main.css">
    <!-- 添加 pdf.js CDN 用于 PDF 解析 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-storage-compat.js"></script>
</head>
<body data-theme="light" oncontextmenu="return false;">
    <!-- 登录容器（简单用户名登录） -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-header">👾 RiverXILee-AI</div>
            <input type="text" class="login-input" id="usernameInput" placeholder="请输入用户名登录">
            <button class="login-btn" onclick="login()">登录</button>
            <div style="font-size: 12px; margin-top: 10px; color: var(--text-secondary);">
                支持上传文件格式：图像 (image/*)、文本 (txt)、PDF (pdf)。总容量 1GB。文档解析：TXT 完整读取，PDF 使用 pdf.js 提取文本，图像仅描述。
            </div>
        </div>
    </div>

    <!-- 主应用容器 -->
    <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display: none;" title="注销">注销</button>
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="切换主题" style="display: none;">🌙</button>
    <!-- 新增：存储状态显示 -->
    <div class="storage-status" id="storageStatus" style="display: none;">文件存储: 0/1024 MB</div>
    <!-- 新增：Token 状态显示 -->
    <div class="token-status" id="tokenStatus" style="display: none;">Tokens: 0/12800</div>
    <div class="app-container" id="appContainer">
        <div class="history-sidebar" id="historySidebar">
            <div class="history-header">
                <span>历史对话</span>
                <button class="new-chat-btn" onclick="newConversation()">+ 新对话</button>
            </div>
            <input type="text" class="search-input" id="historySearch" placeholder="搜索历史对话..." oninput="searchHistory()">
            <div class="search-results" id="searchResults"></div>
            <ul class="history-list" id="historyList"></ul>
        </div>
        <div class="chat-container">
            <div class="header">
                <span>👾</span>
                RiverXILee-AI
                <span class="status-indicator"><span class="dot">●</span> <span class="text">在线</span></span>
            </div>
            <div class="messages" id="messages"></div>
            <div class="loading" id="loading">
                <div class="message ai">
                    <div class="message-bubble">思考中... 🔗</div>
                </div>
            </div>
            <div class="input-area">
                <input type="text" id="userInput" placeholder="输入消息... (支持上传 image/*, .txt, .pdf；总容量1GB；上下文限12800 tokens)" onkeypress="handleKeyPress(event)">
                <input type="file" id="fileInput" class="file-input" accept="image/*,.txt,.pdf" onchange="handleFileUpload(event)" multiple>
                <button class="upload-btn ripple" onclick="document.getElementById('fileInput').click()" title="上传图片/文件 (支持: image, txt, pdf)">📎</button>
                <button class="emoji-btn ripple" onclick="insertEmoji('😊')" title="添加表情">😊</button>
                <button class="ripple" onclick="sendMessage()">发送</button>
                <!-- 新增：停止按钮 -->
                <button class="stop-btn" id="stopBtn" onclick="stopGeneration()" title="停止生成">停止</button>
            </div>
        </div>
    </div>

    <!-- 新增：文件管理模态 -->
    <div id="fileModal" class="file-modal">
        <div class="file-modal-content">
            <div class="file-modal-header">
                <span>上传文件管理</span>
                <button class="file-modal-close" onclick="closeFileModal()">&times;</button>
            </div>
            <ul class="file-list" id="fileListModal"></ul>
            <div class="cloud-status" id="cloudStatus">本地存储 | 云同步状态: <span id="syncStatus">未同步</span></div>
        </div>
    </div>

    <!-- 新增：AI指令模态 -->
    <div id="aiInstructModal" class="ai-instruct-modal">
        <div class="ai-instruct-content">
            <div class="ai-instruct-header">
                <span>自定义AI系统指令</span>
                <button class="file-modal-close" onclick="closeAIInstructModal()">&times;</button>
            </div>
            <textarea class="ai-instruct-textarea" id="aiInstructTextarea" placeholder="输入自定义AI指令，例如：'你是一个专注于代码的AI助手...'"></textarea>
            <button class="ai-instruct-btn" onclick="saveAIInstruct()">保存指令</button>
        </div>
    </div>

    <!-- 新增：工具模块 (整合上传、表情、管理、云、指令) -->
    <button class="tools-module ripple" id="toolsModule" onclick="toggleToolsDropdown()" title="工具箱">🔧</button>
    <div class="tools-dropdown" id="toolsDropdown">
        <button onclick="document.getElementById('fileInput').click()">上传文件</button>
        <button onclick="insertEmoji('😊')">添加表情</button>
        <button onclick="openFileModal()">文件管理</button>
        <button onclick="syncToCloud()">云同步</button>
        <button onclick="openAIInstructModal()">AI指令</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script type="module" src="./js/main.js"></script>
</body>
</html>